<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Offer Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/modern-admin.css">
    <link rel="stylesheet" href="/css/ios-toast.css">
    <style>
      .offer-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .offer-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }
      .offer-status.active { background-color: #28a745; }
      .offer-status.inactive { background-color: #dc3545; }
      .discount-info {
        font-weight: 600;
        color: #e74c3c;
      }
      .form-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }
      .form-section h6 {
        color: #495057;
        margin-bottom: 0.75rem;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="admin-layout">
      <%- include('../layouts/headerAdmin.ejs') %>
      
      <div class="admin-main">
        <header class="admin-header">
          <div class="d-flex align-items-center gap-3">
              <h1 style="font-size: 1.5rem; font-weight: 600; margin: 0;">Offer Management</h1>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary" onclick="openCreateOfferModal()">
              <i class="fas fa-plus"></i> Create Offer
            </button>
          </div>
        </header>
        
        <main class="admin-content">
          <!-- Filter Section -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <select class="form-select" id="filterType" onchange="filterOffers()">
                    <option value="all">All Types</option>
                    <option value="PRODUCT">Product Offers</option>
                    <option value="CATEGORY">Category Offers</option>
                    <option value="BRAND">Brand Offers</option>
                    <option value="FESTIVAL">Festival Offers</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select class="form-select" id="filterStatus" onchange="filterOffers()">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" id="searchOffer" placeholder="Search offers..." onkeyup="searchOffers()">
                    <button class="btn btn-outline-secondary" type="button">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Offers Table -->
          <div class="card">
            <div class="card-header">
              <h4 class="card-title mb-0">Active Offers</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead>
                    <tr>
                      <th>Offer Details</th>
                      <th>Type</th>
                      <th>Discount</th>
                      <th>Validity</th>
                      <th>Usage</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="offersTableBody">
                    <% if (hasOffers) { %>
                      <% offers.forEach((offer) => { %>
                        <tr>
                          <td>
                            <div>
                              <h6 class="mb-1"><%= offer.name %></h6>
                              <small class="text-muted"><%= offer.description %></small>
                            </div>
                          </td>
                          <td>
                            <span class="badge offer-type-badge bg-primary">
                              <%= offer.offerType %>
                            </span>
                            <% if (offer.festivalName) { %>
                              <br><small class="text-muted"><%= offer.festivalName %></small>
                            <% } %>
                          </td>
                          <td>
                            <div class="discount-info">
                              <% if (offer.discountType === 'PERCENTAGE') { %>
                                <%= offer.discountValue %>% OFF
                              <% } else { %>
                                ₹<%= offer.discountValue %> OFF
                              <% } %>
                            </div>
                            <% if (offer.maxDiscountAmount) { %>
                              <small class="text-muted">Max: ₹<%= offer.maxDiscountAmount %></small>
                            <% } %>
                          </td>
                          <td>
                            <div>
                              <small class="text-muted">
                                <%= new Date(offer.startDate).toLocaleDateString() %> - 
                                <%= new Date(offer.endDate).toLocaleDateString() %>
                              </small>
                            </div>
                            <% if (offer.minOrderValue > 0) { %>
                              <small class="text-info">Min: ₹<%= offer.minOrderValue %></small>
                            <% } %>
                          </td>
                          <td>
                            <div>
                              <%= offer.usedCount || 0 %>
                              <% if (offer.usageLimit) { %>
                                / <%= offer.usageLimit %>
                              <% } else { %>
                                / ∞
                              <% } %>
                            </div>
                          </td>
                          <td>
                            <span class="offer-status <%= offer.isActive ? 'active' : 'inactive' %>"></span>
                            <%= offer.isActive ? 'Active' : 'Inactive' %>
                          </td>
                          <td>
                            <div class="btn-group" role="group">
                              <button class="btn btn-sm btn-outline-primary" onclick="viewOffer('<%= offer._id %>')">
                                <i class="fas fa-eye"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-warning" onclick="editOffer('<%= offer._id %>')">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-<%= offer.isActive ? 'secondary' : 'success' %>" 
                                      onclick="toggleOfferStatus('<%= offer._id %>', <%= offer.isActive %>)">
                                <i class="fas fa-<%= offer.isActive ? 'pause' : 'play' %>"></i>
                              </button>
                              <button class="btn btn-sm btn-outline-danger" onclick="deleteOffer('<%= offer._id %>')">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                          <i class="fas fa-tags fa-3x mb-3"></i>
                          <p>No offers found.</p>
                          <button class="btn btn-primary" onclick="openCreateOfferModal()">
                            Create Your First Offer
                          </button>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Create/Edit Offer Modal -->
    <div class="modal fade" id="offerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="offerModalLabel">Create Offer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="offerForm">
              <input type="hidden" id="offerId">
              
              <!-- Basic Information -->
              <div class="form-section">
                <h6><i class="fas fa-info-circle"></i> Basic Information</h6>
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Offer Name *</label>
                    <input type="text" class="form-control" id="offerName" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Offer Type *</label>
                    <select class="form-select" id="offerType" onchange="handleOfferTypeChange()" required>
                      <option value="">Select Type</option>
                      <option value="PRODUCT">Product Offer</option>
                      <option value="CATEGORY">Category Offer</option>
                      <option value="BRAND">Brand Offer</option>
                      <option value="FESTIVAL">Festival Offer</option>
                    </select>
                  </div>
                </div>
                <div class="mt-3">
                  <label class="form-label">Description *</label>
                  <textarea class="form-control" id="offerDescription" rows="2" required></textarea>
                </div>
              </div>

              <!-- Discount Configuration -->
              <div class="form-section">
                <h6><i class="fas fa-percentage"></i> Discount Configuration</h6>
                <div class="row">
                  <div class="col-md-4">
                    <label class="form-label">Discount Type *</label>
                    <select class="form-select" id="discountType" required>
                      <option value="">Select Type</option>
                      <option value="PERCENTAGE">Percentage</option>
                      <option value="FIXED_AMOUNT">Fixed Amount</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Discount Value *</label>
                    <input type="number" class="form-control" id="discountValue" min="0" step="0.01" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Max Discount Amount</label>
                    <input type="number" class="form-control" id="maxDiscountAmount" min="0" step="0.01">
                    <small class="text-muted">For percentage discounts</small>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Minimum Order Value</label>
                    <input type="number" class="form-control" id="minOrderValue" min="0" step="0.01" value="0">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Priority</label>
                    <input type="number" class="form-control" id="priority" min="1" value="1">
                    <small class="text-muted">Higher number = higher priority</small>
                  </div>
                </div>
              </div>

              <!-- Applicability -->
              <div class="form-section" id="applicabilitySection">
                <h6><i class="fas fa-target"></i> Applicability</h6>
                <div id="productSelection" style="display: none;">
                  <label class="form-label">Select Products</label>
                  <div class="multi-select-container">
                    <div class="search-box mb-2">
                      <input type="text" class="form-control" id="productSearch" placeholder="Search products..." onkeyup="searchItems('products')">
                    </div>
                    <div class="select-all-box mb-2">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" id="selectAllProducts" onchange="toggleSelectAll('products')">
                        Select All Products
                      </label>
                    </div>
                    <div class="items-container" id="productsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                      <!-- Products will be loaded here -->
                    </div>
                    <div class="selected-count mt-2">
                      <small class="text-muted">Selected: <span id="selectedProductsCount">0</span> products</small>
                    </div>
                  </div>
                </div>
                <div id="categorySelection" style="display: none;">
                  <label class="form-label">Select Categories</label>
                  <div class="multi-select-container">
                    <div class="search-box mb-2">
                      <input type="text" class="form-control" id="categorySearch" placeholder="Search categories..." onkeyup="searchItems('categories')">
                    </div>
                    <div class="select-all-box mb-2">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" id="selectAllCategories" onchange="toggleSelectAll('categories')">
                        Select All Categories
                      </label>
                    </div>
                    <div class="items-container" id="categoriesContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                      <!-- Categories will be loaded here -->
                    </div>
                    <div class="selected-count mt-2">
                      <small class="text-muted">Selected: <span id="selectedCategoriesCount">0</span> categories</small>
                    </div>
                  </div>
                </div>
                <div id="brandSelection" style="display: none;">
                  <label class="form-label">Select Brands</label>
                  <div class="multi-select-container">
                    <div class="search-box mb-2">
                      <input type="text" class="form-control" id="brandSearch" placeholder="Search brands..." onkeyup="searchItems('brands')">
                    </div>
                    <div class="select-all-box mb-2">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" id="selectAllBrands" onchange="toggleSelectAll('brands')">
                        Select All Brands
                      </label>
                    </div>
                    <div class="items-container" id="brandsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                      <!-- Brands will be loaded here -->
                    </div>
                    <div class="selected-count mt-2">
                      <small class="text-muted">Selected: <span id="selectedBrandsCount">0</span> brands</small>
                    </div>
                  </div>
                </div>
                <div id="festivalSelection" style="display: none;">
                  <label class="form-label">Festival</label>
                  <select class="form-select" id="festivalName">
                    <option value="">Select Festival</option>
                    <option value="DIWALI">Diwali</option>
                    <option value="ONAM">Onam</option>
                    <option value="CHRISTMAS">Christmas</option>
                    <option value="NEW_YEAR">New Year</option>
                    <option value="HOLI">Holi</option>
                    <option value="EID">Eid</option>
                    <option value="DUSSEHRA">Dussehra</option>
                    <option value="VALENTINE">Valentine's Day</option>
                    <option value="MOTHERS_DAY">Mother's Day</option>
                    <option value="FATHERS_DAY">Father's Day</option>
                  </select>
                </div>
              </div>

              <!-- Validity & Limits -->
              <div class="form-section">
                <h6><i class="fas fa-calendar"></i> Validity & Limits</h6>
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Start Date *</label>
                    <input type="datetime-local" class="form-control" id="startDate" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">End Date *</label>
                    <input type="datetime-local" class="form-control" id="endDate" required>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Usage Limit</label>
                    <input type="number" class="form-control" id="usageLimit" min="1">
                    <small class="text-muted">Leave empty for unlimited</small>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveOffer()">Save Offer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/ios-toast.js"></script>
    <script>
      let formData = {};

      // Load form data on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadFormData();
      });

      async function loadFormData() {
        try {
          const response = await fetch('/admin/offers/form/data');
          const data = await response.json();
          if (data.success) {
            formData = data.data;
            console.log('Form data loaded:', formData); // Debug log
            console.log('Products count:', formData.products ? formData.products.length : 0); // Debug log
            console.log('Categories count:', formData.categories ? formData.categories.length : 0); // Debug log
            console.log('Brands count:', formData.brands ? formData.brands.length : 0); // Debug log
            console.log('Brands data:', formData.brands); // Debug log
          } else {
            console.error('Failed to load form data:', data.message);
          }
        } catch (error) {
          console.error('Error loading form data:', error);
        }
      }

      function openCreateOfferModal() {
        document.getElementById('offerModalLabel').textContent = 'Create Offer';
        document.getElementById('offerForm').reset();
        document.getElementById('offerId').value = '';
        
        // Set default dates
        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('startDate').value = tomorrow.toISOString().slice(0, 16);
        document.getElementById('endDate').value = nextWeek.toISOString().slice(0, 16);
        
        new bootstrap.Modal(document.getElementById('offerModal')).show();
      }

      function handleOfferTypeChange() {
        const offerType = document.getElementById('offerType').value;
        
        // Hide all selection divs
        document.getElementById('productSelection').style.display = 'none';
        document.getElementById('categorySelection').style.display = 'none';
        document.getElementById('brandSelection').style.display = 'none';
        document.getElementById('festivalSelection').style.display = 'none';
        
        // Show relevant selection based on offer type
        if (offerType === 'PRODUCT') {
          document.getElementById('productSelection').style.display = 'block';
          populateCheckboxList('products', formData.products, 'name');
        } else if (offerType === 'CATEGORY') {
          document.getElementById('categorySelection').style.display = 'block';
          populateCheckboxList('categories', formData.categories, 'name');
        } else if (offerType === 'BRAND') {
          document.getElementById('brandSelection').style.display = 'block';
          populateCheckboxList('brands', formData.brands, 'name');
        } else if (offerType === 'FESTIVAL') {
          document.getElementById('festivalSelection').style.display = 'block';
        }
      }

      function populateCheckboxList(type, options, labelField) {
        const container = document.getElementById(`${type}Container`);
        container.innerHTML = '';
        
        console.log(`Populating ${type} with ${options ? options.length : 0} items`); // Debug log
        
        if (options && options.length > 0) {
          options.forEach(option => {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check mb-1';
            checkboxDiv.innerHTML = `
              <input class="form-check-input ${type}-checkbox" type="checkbox" value="${option._id}" id="${type}_${option._id}" onchange="updateSelectedCount('${type}')">
              <label class="form-check-label" for="${type}_${option._id}">
                ${option[labelField]} ${option.price ? `(₹${option.price})` : ''}
              </label>
            `;
            container.appendChild(checkboxDiv);
          });
        } else {
          container.innerHTML = `<p class="text-muted">No ${type} available</p>`;
        }
        updateSelectedCount(type);
      }

      function searchItems(type) {
        const searchTerm = document.getElementById(`${type.slice(0, -1)}Search`).value.toLowerCase();
        const checkboxes = document.querySelectorAll(`#${type}Container .form-check`);
        
        checkboxes.forEach(checkbox => {
          const label = checkbox.querySelector('label').textContent.toLowerCase();
          if (label.includes(searchTerm)) {
            checkbox.style.display = 'block';
          } else {
            checkbox.style.display = 'none';
          }
        });
      }

      function toggleSelectAll(type) {
        const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        const itemCheckboxes = document.querySelectorAll(`.${type}-checkbox`);
        const visibleCheckboxes = Array.from(itemCheckboxes).filter(cb => cb.closest('.form-check').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelectedCount(type);
      }

      function updateSelectedCount(type) {
        const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
        const countElement = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Count`);
        if (countElement) {
          countElement.textContent = checkboxes.length;
        }
        
        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll(`.${type}-checkbox`);
        const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.closest('.form-check').style.display !== 'none');
        const checkedVisibleCheckboxes = visibleCheckboxes.filter(cb => cb.checked);
        const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
        
        if (selectAllCheckbox) {
          if (checkedVisibleCheckboxes.length === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
          } else if (checkedVisibleCheckboxes.length === visibleCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
          } else {
            selectAllCheckbox.indeterminate = true;
          }
        }
      }

      function getSelectedItems(type) {
        const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
        return Array.from(checkboxes).map(cb => cb.value);
      }

      async function saveOffer() {
        const form = document.getElementById('offerForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const offerId = document.getElementById('offerId').value;
        const isEdit = !!offerId;
        
        const offerData = {
          name: document.getElementById('offerName').value,
          description: document.getElementById('offerDescription').value,
          offerType: document.getElementById('offerType').value,
          discountType: document.getElementById('discountType').value,
          discountValue: parseFloat(document.getElementById('discountValue').value),
          maxDiscountAmount: document.getElementById('maxDiscountAmount').value ? parseFloat(document.getElementById('maxDiscountAmount').value) : null,
          minOrderValue: parseFloat(document.getElementById('minOrderValue').value) || 0,
          priority: parseInt(document.getElementById('priority').value) || 1,
          startDate: document.getElementById('startDate').value,
          endDate: document.getElementById('endDate').value,
          usageLimit: document.getElementById('usageLimit').value ? parseInt(document.getElementById('usageLimit').value) : null
        };

        // Add applicability based on offer type
        const offerType = offerData.offerType;
        if (offerType === 'PRODUCT') {
          offerData.applicableProducts = getSelectedItems('products');
        } else if (offerType === 'CATEGORY') {
          offerData.applicableCategories = getSelectedItems('categories');
        } else if (offerType === 'BRAND') {
          offerData.applicableBrands = getSelectedItems('brands');
        } else if (offerType === 'FESTIVAL') {
          offerData.festivalName = document.getElementById('festivalName').value;
        }

        try {
          const url = isEdit ? `/admin/offers/${offerId}` : '/admin/offers';
          const method = isEdit ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(offerData)
          });

          const result = await response.json();
          
          if (result.success) {
            Toast.success('Success', result.message);
            setTimeout(() => location.reload(), 1500);
          } else {
            Toast.error('Error', result.message);
          }
        } catch (error) {
          console.error('Error saving offer:', error);
          Toast.error('Error', 'Failed to save offer');
        }
      }

      async function toggleOfferStatus(offerId, currentStatus) {
        try {
          const response = await fetch(`/admin/offers/${offerId}/toggle`, {
            method: 'POST'
          });
          
          const result = await response.json();
          
          if (result.success) {
            Toast.success('Success', result.message);
            setTimeout(() => location.reload(), 1500);
          } else {
            Toast.error('Error', result.message);
          }
        } catch (error) {
          console.error('Error toggling offer status:', error);
          Toast.error('Error', 'Failed to update offer status');
        }
      }

      async function deleteOffer(offerId) {
        const confirmed = await Toast.confirm({
          title: 'Delete Offer',
          message: 'Are you sure you want to delete this offer? This action cannot be undone.',
          confirmText: 'Delete',
          cancelText: 'Cancel',
          type: 'error'
        });

        if (confirmed) {
          try {
            const response = await fetch(`/admin/offers/${offerId}`, {
              method: 'DELETE'
            });
            
            const deleteResult = await response.json();
            
            if (deleteResult.success) {
              Toast.success('Deleted', deleteResult.message);
              setTimeout(() => location.reload(), 1500);
            } else {
              Toast.error('Delete Failed', deleteResult.message);
            }
          } catch (error) {
            console.error('Error deleting offer:', error);
            Toast.error('Error', 'Failed to delete offer');
          }
        }
      }

      // Filter and search functions
      function filterOffers() {
        console.log('Filtering offers...');
      }

      function searchOffers() {
        console.log('Searching offers...');
      }

      function viewOffer(offerId) {
        console.log('Viewing offer:', offerId);
      }

      async function editOffer(offerId) {
        try {
          // Fetch offer details
          const response = await fetch(`/admin/offers/${offerId}`);
          const data = await response.json();
          
          if (!data.success) {
            Toast.error('Error', 'Failed to load offer details');
            return;
          }
          
          const offer = data.offer;
          
          // Populate the form
          document.getElementById('offerId').value = offer._id;
          document.getElementById('offerName').value = offer.name;
          document.getElementById('offerDescription').value = offer.description || '';
          document.getElementById('offerType').value = offer.offerType;
          document.getElementById('discountType').value = offer.discountType;
          document.getElementById('discountValue').value = offer.discountValue;
          document.getElementById('minOrderValue').value = offer.minOrderValue || 0;
          document.getElementById('maxDiscountAmount').value = offer.maxDiscountAmount || '';
          document.getElementById('priority').value = offer.priority || 1;
          
          // Format dates for datetime-local input
          if (offer.startDate) {
            const startDate = new Date(offer.startDate);
            document.getElementById('startDate').value = startDate.toISOString().slice(0, 16);
          }
          if (offer.endDate) {
            const endDate = new Date(offer.endDate);
            document.getElementById('endDate').value = endDate.toISOString().slice(0, 16);
          }
          
          document.getElementById('usageLimit').value = offer.usageLimit || '';
          
          // Handle festival name for festival offers
          if (offer.offerType === 'FESTIVAL' && offer.festivalName) {
            document.getElementById('festivalName').value = offer.festivalName;
          }
          
          // Trigger offer type change to show appropriate selection UI
          handleOfferTypeChange();
          
          // Handle applicable items based on offer type
          if (offer.offerType === 'PRODUCT' && offer.applicableProducts) {
            // Wait for products to load, then select them
            setTimeout(() => {
              offer.applicableProducts.forEach(productId => {
                const checkbox = document.querySelector(`.products-checkbox[value="${productId}"]`);
                if (checkbox) checkbox.checked = true;
              });
              updateSelectedCount('products');
            }, 500);
          } else if (offer.offerType === 'CATEGORY' && offer.applicableCategories) {
            setTimeout(() => {
              offer.applicableCategories.forEach(categoryId => {
                const checkbox = document.querySelector(`.categories-checkbox[value="${categoryId}"]`);
                if (checkbox) checkbox.checked = true;
              });
              updateSelectedCount('categories');
            }, 500);
          } else if (offer.offerType === 'BRAND' && offer.applicableBrands) {
            setTimeout(() => {
              offer.applicableBrands.forEach(brandId => {
                const checkbox = document.querySelector(`.brands-checkbox[value="${brandId}"]`);
                if (checkbox) checkbox.checked = true;
              });
              updateSelectedCount('brands');
            }, 500);
          }
          
          // Update modal title and show
          document.getElementById('offerModalLabel').textContent = 'Edit Offer';
          const modal = new bootstrap.Modal(document.getElementById('offerModal'));
          modal.show();
          
        } catch (error) {
          console.error('Error loading offer:', error);
          Toast.error('Error', 'Failed to load offer details');
        }
      }
    </script>
  </body>
</html>