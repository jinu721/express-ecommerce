<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order #<%= order.orderId %> - Admin Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/modern-admin.css" />
    <style>
      .order-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
      }
      .status-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
      }
      .order-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }
      .detail-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .items-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-order_placed { background: #e3f2fd; color: #1976d2; }
      .status-confirmed { background: #f3e5f5; color: #7b1fa2; }
      .status-packed { background: #fff3e0; color: #f57c00; }
      .status-shipped { background: #e8f5e8; color: #388e3c; }
      .status-out_for_delivery { background: #fff8e1; color: #f9a825; }
      .status-delivered { background: #e8f5e8; color: #2e7d32; }
      .status-cancelled { background: #ffebee; color: #d32f2f; }
      .status-returned { background: #fce4ec; color: #c2185b; }
      
      .timeline {
        position: relative;
        padding-left: 2rem;
      }
      .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e0e0e0;
      }
      .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
      }
      .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #2196f3;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #e3f2fd;
      }
    </style>
  </head>
  <body>
    <input type="hidden" value="<%= order._id %>" id="orderId" />
    <input type="hidden" value="<%= order.user %>" id="userId" />
    <input type="hidden" value="<%= order.orderStatus %>" id="currentOrderStatus" />

    <header><%- include('../layouts/headerAdmin.ejs') %></header>
    
    <main class="container-fluid py-4">
      <!-- Order Header -->
      <div class="order-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1><i class="fas fa-shopping-bag"></i> Order #<%= order.orderId %></h1>
            <p class="mb-0">Placed on <%= new Date(order.orderedAt).toLocaleDateString() %> at <%= new Date(order.orderedAt).toLocaleTimeString() %></p>
          </div>
          <div class="col-md-4 text-end">
            <div class="status-badge status-<%= order.orderStatus %>">
              <%= order.orderStatus.replace('_', ' ').toUpperCase() %>
            </div>
            <div class="mt-2">
              <strong>₹<%= order.totalAmount %></strong>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
          <!-- Status Update Section -->
          <div class="status-card">
            <h4><i class="fas fa-edit"></i> Update Order Status</h4>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Status</label>
                <select id="order-status" class="form-select">
                  <option value="order_placed" <%= order.orderStatus === 'order_placed' ? 'selected' : '' %>>Order Placed</option>
                  <option value="confirmed" <%= order.orderStatus === 'confirmed' ? 'selected' : '' %>>Confirmed</option>
                  <option value="packed" <%= order.orderStatus === 'packed' ? 'selected' : '' %>>Packed</option>
                  <option value="shipped" <%= order.orderStatus === 'shipped' ? 'selected' : '' %>>Shipped</option>
                  <option value="out_for_delivery" <%= order.orderStatus === 'out_for_delivery' ? 'selected' : '' %>>Out for Delivery</option>
                  <option value="delivered" <%= order.orderStatus === 'delivered' ? 'selected' : '' %>>Delivered</option>
                  <option value="cancelled" <%= order.orderStatus === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Location (Optional)</label>
                <input type="text" id="status-location" placeholder="e.g., Mumbai Sorting Facility" class="form-control">
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Status Message (Optional)</label>
              <textarea id="status-message" placeholder="Additional details about the status update..." class="form-control" rows="2"></textarea>
            </div>
            <button class="btn btn-primary mt-3 update-status-btn">
              <i class="fas fa-save"></i> Update Status
            </button>
          </div>

          <!-- Order Items -->
          <div class="items-table">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>Product</th>
                    <th>Variant</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach((item, index) => { %>
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <img src="<%= item.product.imageUrl && item.product.imageUrl[0] ? item.product.imageUrl[0] : '/img/default-product.jpg' %>" 
                               alt="<%= item.product.name %>" 
                               style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; margin-right: 10px;">
                          <div>
                            <strong><%= item.product.name %></strong>
                            <% if (item.appliedOffer) { %>
                              <br><small class="text-success"><i class="fas fa-tag"></i> <%= item.appliedOffer.name %></small>
                            <% } %>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="badge bg-secondary"><%= item.size %></span>
                        <span class="badge bg-info"><%= item.color %></span>
                      </td>
                      <td>
                        <% if (item.discount > 0) { %>
                          <span class="text-decoration-line-through text-muted">₹<%= item.originalPrice %></span><br>
                        <% } %>
                        <strong>₹<%= item.offerPrice %></strong>
                      </td>
                      <td><%= item.quantity %></td>
                      <td><strong>₹<%= item.totalPrice %></strong></td>
                      <td>
                        <span class="status-badge status-<%= item.itemStatus %>">
                          <%= item.itemStatus.replace('_', ' ').toUpperCase() %>
                        </span>
                      </td>
                      <td>
                        <% if (item.returnRequest && item.returnRequest.requestStatus && item.returnRequest.adminStatus === 'pending') { %>
                          <button class="btn btn-sm btn-warning" onclick="viewReturnRequest('<%= item._id %>', '<%= item.returnRequest.requestMessage %>')">
                            <i class="fas fa-undo"></i> Return Request
                          </button>
                        <% } else if (item.returnRequest && item.returnRequest.adminStatus === 'approved') { %>
                          <span class="badge bg-success">Return Approved</span>
                        <% } else if (item.returnRequest && item.returnRequest.adminStatus === 'cancelled') { %>
                          <span class="badge bg-danger">Return Rejected</span>
                        <% } else { %>
                          <span class="text-muted">No requests</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Order Summary -->
          <div class="detail-card mt-4">
            <h5><i class="fas fa-calculator"></i> Order Summary</h5>
            <div class="row">
              <div class="col-md-6">
                <table class="table table-sm">
                  <tr>
                    <td>Subtotal:</td>
                    <td class="text-end">₹<%= order.subtotal || order.totalAmount %></td>
                  </tr>
                  <% if (order.totalDiscount > 0) { %>
                    <tr class="text-success">
                      <td>Offer Discount:</td>
                      <td class="text-end">-₹<%= order.totalDiscount %></td>
                    </tr>
                  <% } %>
                  <% if (order.coupon && order.coupon.discountApplied > 0) { %>
                    <tr class="text-success">
                      <td>Coupon (<%= order.coupon.code %>):</td>
                      <td class="text-end">-₹<%= order.coupon.discountApplied %></td>
                    </tr>
                  <% } %>
                  <% if (order.shippingCost > 0) { %>
                    <tr>
                      <td>Shipping:</td>
                      <td class="text-end">₹<%= order.shippingCost %></td>
                    </tr>
                  <% } %>
                  <tr class="table-dark">
                    <td><strong>Total:</strong></td>
                    <td class="text-end"><strong>₹<%= order.totalAmount %></strong></td>
                  </tr>
                </table>
              </div>
              <div class="col-md-6">
                <p><strong>Payment Method:</strong> <%= order.paymentMethod.replace('_', ' ').toUpperCase() %></p>
                <p><strong>Payment Status:</strong> 
                  <span class="badge <%= order.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning' %>">
                    <%= order.paymentStatus.toUpperCase() %>
                  </span>
                </p>
                <% if (order.razorpayOrderId) { %>
                  <p><strong>Razorpay Order ID:</strong> <code><%= order.razorpayOrderId %></code></p>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
          <!-- Customer Info -->
          <div class="detail-card">
            <h5><i class="fas fa-user"></i> Customer Information</h5>
            <p><strong>Customer ID:</strong> <%= order.user %></p>
            <p><strong>Order Date:</strong> <%= new Date(order.orderedAt).toLocaleDateString() %></p>
            <% if (order.deliveredAt) { %>
              <p><strong>Delivered:</strong> <%= new Date(order.deliveredAt).toLocaleDateString() %></p>
            <% } %>
          </div>

          <!-- Shipping Address -->
          <div class="detail-card">
            <h5><i class="fas fa-map-marker-alt"></i> Shipping Address</h5>
            <address>
              <%= order.shippingAddress.houseNumber %>, <%= order.shippingAddress.street %><br>
              <% if (order.shippingAddress.landMark) { %>
                Near <%= order.shippingAddress.landMark %><br>
              <% } %>
              <%= order.shippingAddress.city %>, <%= order.shippingAddress.district %><br>
              <%= order.shippingAddress.state %>, <%= order.shippingAddress.country %><br>
              <strong>PIN:</strong> <%= order.shippingAddress.pinCode %>
            </address>
          </div>

          <!-- Status History -->
          <div class="detail-card">
            <h5><i class="fas fa-history"></i> Status History</h5>
            <div class="timeline">
              <% order.statusHistory.reverse().forEach(status => { %>
                <div class="timeline-item">
                  <div>
                    <strong><%= status.status.replace('_', ' ').toUpperCase() %></strong>
                    <% if (status.location) { %>
                      <br><small class="text-muted"><i class="fas fa-map-pin"></i> <%= status.location %></small>
                    <% } %>
                    <% if (status.message) { %>
                      <br><small class="text-muted"><%= status.message %></small>
                    <% } %>
                    <br><small class="text-muted"><%= new Date(status.updatedAt).toLocaleString() %></small>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>

          <!-- Return Requests -->
          <% if (order.returnRequest && order.returnRequest.requestStatus && order.returnRequest.adminStatus === 'pending') { %>
            <div class="detail-card">
              <h5><i class="fas fa-undo"></i> Order Return Request</h5>
              <p><strong>Reason:</strong> <%= order.returnRequest.requestMessage %></p>
              <div class="d-flex gap-2">
                <button class="btn btn-success btn-sm btn-requestApproved">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger btn-sm btn-requestCancel">
                  <i class="fas fa-times"></i> Reject
                </button>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </main>

    <!-- Return Request Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Item Return Request</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Return Reason:</strong></p>
            <p id="return-reason"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="handleItemReturn('reject')">
              <i class="fas fa-times"></i> Reject
            </button>
            <button type="button" class="btn btn-success" onclick="handleItemReturn('approve')">
              <i class="fas fa-check"></i> Approve
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin/orderView.js"></script>
  </body>
</html>