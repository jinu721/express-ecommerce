<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Products Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://unpkg.com/cropperjs@1.5.12/dist/cropper.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/modern-admin.css" />
    <link rel="stylesheet" href="/css/ios-toast.css" />
    <link rel="stylesheet" href="/css/image-selector.css" />
    <style>
      .search-bar {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }
      .search-bar input {
        flex: 1;
        min-width: 250px;
      }
      .product-image-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: var(--border-radius);
      }
      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }
      .pagination {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
        justify-content: center;
        margin-top: 2rem;
      }
      .pagination__link {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        color: var(--text-main);
        text-decoration: none;
        transition: all 0.2s;
      }
      .pagination__link:hover, .pagination__link.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }
      .error-message {
        color: var(--danger-color);
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      .image-section {
        margin-bottom: 1rem;
      }
      .cropPreviewSection {
        margin-top: 0.5rem;
      }
      .no-image-thumb {
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border: 1px dashed #dee2e6;
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="admin-layout">
      <%- include('../layouts/headerAdmin.ejs') %>
      
      <div class="admin-main">
        <header class="admin-header">
          <h1 style="font-size: 1.5rem; font-weight: 600; margin: 0;">Products Management</h1>
        </header>
        
        <main class="admin-content">
          <div class="card">
            <div class="card-header">
              <h4 class="card-title">All Products</h4>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productUploadModal">
                <i class="fas fa-plus"></i> Add New Product
              </button>
            </div>
            <div class="card-body">
              <form class="search-bar">
                <input
                  type="text"
                  class="form-control searchProducts"
                  placeholder="Search products..."
                  oninput="searchDebouncing()"
                />
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search"></i> Search
                </button>
              </form>
              
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>No</th>
                      <th>Image 1</th>
                      <th>Image 2</th>
                      <th>Image 3</th>
                      <th>Image 4</th>
                      <th>Name</th>
                      <th>Category</th>
                      <th>Brand</th>
                      <th>Price</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody class="resultContainer">
                    <% if(!val){ %>
                      <tr>
                        <td colspan="11" style="text-align: center;"><%= msg %></td>
                      </tr>
                    <% }else{ %> 
                      <% products.forEach((data,index)=>{ %>
                        <tr>
                          <td><%= index+1 %></td>
                          <% for(let i = 0; i < 4; i++) { %>
                            <td>
                              <% if(data.images && data.images[i]) { %>
                                <img src="/<%= data.images[i] %>" alt="<%= data.name %>" class="product-image-thumb" />
                              <% } else { %>
                                <div class="no-image-thumb">
                                  <i class="fas fa-image"></i>
                                </div>
                              <% } %>
                            </td>
                          <% } %>
                          <td><%= data.name %></td>
                          <td>
                            <% category.forEach((x)=>{ %> 
                              <% if(x._id.toString()===data.category.toString()){ %>
                                <%= x.name %> 
                              <% } %> 
                            <% }) %>
                          </td>
                          <td>
                            <% if (typeof data.brand === 'object' && data.brand) { %>
                              <%= data.brand.name %>
                            <% } else { %>
                              <% brands.forEach((brand) => { %>
                                <% if (brand._id.toString() === data.brand.toString()) { %>
                                  <%= brand.name %>
                                <% } %>
                              <% }) %>
                            <% } %>
                          </td>
                          <td>₹<%= data.price %></td>
                          <td>
                            <span
                              data-id="<%= data._id %>"
                              class="badge btnListAndUnlist <%= data.isDeleted?'badge-outline-success':'badge-outline-danger' %>"
                              style="cursor: pointer;"
                            >
                              <%= data.isDeleted?'List':'Unlist' %>
                            </span>
                          </td>
                          <td>
                            <div class="action-buttons">
                              <button class="btn btn-sm btn-outline-warning" onclick="openEditModal('<%= data._id %>')" title="Edit Product">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <a href="/admin/products/<%= data._id %>/variants/manage" class="btn btn-sm btn-outline-info" title="Manage Variants">
                                <i class="fas fa-layer-group"></i> Variants
                              </a>
                              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('<%= data._id %>')" title="Delete Permanently">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }) %> 
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <ul class="pagination">
            <% let startPage = Math.max(1, currentPage - Math.floor(pagesToShow / 2)); %>
            <% let endPage = Math.min(totalPages, startPage + pagesToShow - 1); %>
            <% if (endPage - startPage + 1 < pagesToShow) { %>
              <% startPage = Math.max(1, endPage - pagesToShow + 1); %>
            <% } %>
            <% if (currentPage > pagesToShow) { %>
              <li><a href="?page=1" class="pagination__link">01</a></li>
            <% } %>
            <% for (let i = startPage; i <= endPage; i++) { %>
              <li>
                <a href="?page=<%= i %>" class="pagination__link <%= currentPage === i ? 'active' : '' %>">
                  <%= i < 10 ? '0' + i : i %>
                </a>
              </li>
            <% } %>
            <% if (endPage < totalPages) { %>
              <li>
                <a href="?page=<%= currentPage + pagesToShow %>" class="pagination__link">
                  <i class="fa-solid fa-arrow-right"></i>
                </a>
              </li>
              <li>
                <a href="?page=<%= totalPages %>" class="pagination__link">
                  <%= totalPages < 10 ? '0' + totalPages : totalPages %>
                </a>
              </li>
            <% } %>
          </ul>
        </main>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="productUploadModal" tabindex="-1" aria-labelledby="productUploadModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productUploadModalLabel">Add New Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form class="forms-sample" id="productForm" enctype="multipart/form-data" novalidate>
              <input style="display: none" type="file" class="product-image" multiple required />
              
              <div class="form-group">
                <label for="productName" class="form-label">Name</label>
                <input type="text" class="form-control product-name" id="productName" name="name" placeholder="Product Name" required />
                <p class="error-message" id="productNameError"></p>
              </div>

              <div class="form-group">
                <label class="form-label">Product Images</label>
                <div id="imageSelector"></div>
              </div>

              <div class="form-group">
                <label for="productDescription" class="form-label">Description</label>
                <input type="text" class="form-control product-desc" id="productDescription" name="description" placeholder="Product Description" required />
                <p class="error-message" id="descError"></p>
              </div>

              <div class="form-group">
                <label for="productCategory" class="form-label">Category</label>
                <select class="form-control" id="productCategory" name="category" required>
                  <option value="">Select Category</option>
                  <% category.forEach((data)=>{ %>
                    <option value="<%= data._id %>"><%= data.name %></option>
                  <% }) %>
                </select>
                <p class="error-message" id="categoryError"></p>
              </div>

              <div class="form-group">
                <label for="productTags" class="form-label">Tags</label>
                <input type="text" class="form-control product-tags" id="productTags" placeholder="Product tags" required />
              </div>

              <div class="form-group">
                <label for="productBrand" class="form-label">Brand</label>
                <select class="form-control" id="productBrand" name="brand" required>
                  <option value="">Select Brand</option>
                  <% brands.forEach((brand)=>{ %>
                    <option value="<%= brand._id %>"><%= brand.name %></option>
                  <% }) %>
                </select>
                <p class="error-message" id="brandError"></p>
              </div>

              <div class="form-group">
                <label for="productOgPrice" class="form-label">Price</label>
                <input type="number" class="form-control product-og-price" id="productOgPrice" placeholder="Original Price" required />
                <p class="error-message" id="ogPriceError"></p>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="cashOnDelivery" />
                  <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
                </div>
              </div>



              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="toggleWarranty" onclick="toggleWarrantyInput()" />
                  <label class="form-check-label" for="toggleWarranty">Add Warranty</label>
                </div>
                <div class="warranty-input mt-2" id="warrantyDiv" style="display: none">
                  <label for="productWarranty" class="form-label">Warranty</label>
                  <input type="text" class="form-control product-warranty" id="productWarranty" placeholder="Warranty" />
                  <p class="error-message" id="warrantyError"></p>
                </div>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="toggleReturnPolicy" onclick="toggleReturnPolicyInput()" />
                  <label class="form-check-label" for="toggleReturnPolicy">Add Return Policy</label>
                </div>
                <div class="return-policy-input mt-2" id="returnPolicyDiv" style="display: none">
                  <label for="productReturnPolicy" class="form-label">Return Policy</label>
                  <input type="text" class="form-control product-return-policy" id="productReturnPolicy" placeholder="Return Policy" />
                  <p class="error-message" id="returnPolicyError"></p>
                </div>
              </div>
              
              <!-- Shipping Configuration -->
              <div class="form-group">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="hasCustomShipping" name="hasCustomShipping" onclick="toggleShippingInput()" />
                  <label class="form-check-label" for="hasCustomShipping">Custom Shipping Price</label>
                </div>
                <div class="shipping-input mt-2" id="shippingDiv" style="display: none">
                  <label for="shippingPrice" class="form-label">Shipping Price (₹)</label>
                  <input type="number" class="form-control" id="shippingPrice" name="shippingPrice" placeholder="0" min="0" />
                  <small class="form-text text-muted">Leave 0 for free shipping. Default shipping rules apply if unchecked.</small>
                </div>
              </div>

              <button type="submit" class="btn btn-primary mt-3 btn-CreateProduct">Create Product</button>
              <div class="alert alert-info mt-2">
                <i class="fas fa-info-circle"></i> After creating the product, use the "Variants" button to manage product variants and stock.
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="productUpdateModal" tabindex="-1" aria-labelledby="productUpdateModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productUpdateModalLabel">Update Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form class="forms-sample" id="productUpdateForm" enctype="multipart/form-data" novalidate>
              <input type="hidden" id="updateProductId" name="id">
              
              <div class="form-group">
                <label for="updateProductName" class="form-label">Name</label>
                <input type="text" class="form-control" id="updateProductName" name="name" required />
                <p class="error-message" id="updateNameError"></p>
              </div>

              <div class="form-group">
                <label for="updateProductDescription" class="form-label">Description</label>
                <textarea class="form-control" id="updateProductDescription" rows="3"></textarea>
              </div>

               <div class="form-group">
                <label for="updateProductCategory" class="form-label">Category</label>
                <select class="form-control" id="updateProductCategory" name="category">
                   <% category.forEach((data)=>{ %>
                    <option value="<%= data._id %>"><%= data.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="form-group">
                <label for="updateProductBrand" class="form-label">Brand</label>
                <select class="form-control" id="updateProductBrand" name="brand">
                  <option value="">Select Brand</option>
                  <% brands.forEach((brand)=>{ %>
                    <option value="<%= brand._id %>"><%= brand.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="form-group">
                <label for="updateProductPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="updateProductPrice">
              </div>

              <div class="form-group">
                <label for="updateProductTags" class="form-label">Tags</label>
                <input type="text" class="form-control" id="updateProductTags" placeholder="Enter tags separated by #">
                <small class="form-text text-muted">Example: #summer #casual #cotton</small>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateCashOnDelivery">
                  <label class="form-check-label" for="updateCashOnDelivery">
                    Cash on Delivery Available
                  </label>
                </div>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateShowWarranty" onchange="toggleUpdateWarrantyInput()">
                  <label class="form-check-label" for="updateShowWarranty">
                    Add Warranty Information
                  </label>
                </div>
                <div id="updateWarrantyDiv" style="display: none; margin-top: 10px;">
                  <input type="text" class="form-control" id="updateProductWarranty" placeholder="Enter warranty details">
                </div>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateShowReturnPolicy" onchange="toggleUpdateReturnPolicyInput()">
                  <label class="form-check-label" for="updateShowReturnPolicy">
                    Add Return Policy
                  </label>
                </div>
                <div id="updateReturnPolicyDiv" style="display: none; margin-top: 10px;">
                  <textarea class="form-control" id="updateProductReturnPolicy" rows="3" placeholder="Enter return policy details"></textarea>
                </div>
              </div>
              
              <!-- Shipping Configuration -->
              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="updateHasCustomShipping" onchange="toggleUpdateShippingInput()">
                  <label class="form-check-label" for="updateHasCustomShipping">
                    Custom Shipping Price
                  </label>
                </div>
                <div id="updateShippingDiv" style="display: none; margin-top: 10px;">
                  <input type="number" class="form-control" id="updateShippingPrice" placeholder="0" min="0">
                  <small class="form-text text-muted">Leave 0 for free shipping. Default shipping rules apply if unchecked.</small>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Product Images</label>
                <div id="editImageSelector"></div>
              </div>

              <button type="submit" class="btn btn-warning mt-3 btn-UpdateProduct">Update Product</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/ios-toast.js"></script>
    <script src="/js/image-selector.js"></script>
    <script src="/js/admin/products.js" defer></script>
    
    <script>
      // Toggle shipping input visibility
      function toggleShippingInput() {
        const checkbox = document.getElementById('hasCustomShipping');
        const shippingDiv = document.getElementById('shippingDiv');
        shippingDiv.style.display = checkbox.checked ? 'block' : 'none';
      }
      
      function toggleUpdateShippingInput() {
        const checkbox = document.getElementById('updateHasCustomShipping');
        const shippingDiv = document.getElementById('updateShippingDiv');
        shippingDiv.style.display = checkbox.checked ? 'block' : 'none';
      }
    </script>
  </body>
</html>
